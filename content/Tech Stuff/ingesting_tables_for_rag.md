---
title: ᗧ···Ingest tables for RAG application
tags: ["rag"]
categories: []
---

Tables are tricky, even for human, to navigate, let alone understanding/digesting.

>For RAG, ingesting, indexing, and retrieving go hand-in-hand. Explore your options for each.

Let's go over several layers of digesting tables for RAG application (NLP application in general)

## Level 1: Convert pdf tables to pandas 

Usually, tables show up in pdf files or htm/html.

Tables in pdf files can be text-based or images. [Text-based](https://nlsblog.org/2020/06/12/three-types-of-pdfs/) pdf tables can be probed from their internal [structured data](https://reverseengineering.stackexchange.com/questions/14698/can-i-reverse-engineer-a-pdf-file-to-identify-the-creators-name) while the latter requires an OCR solution (usually [tesseract](https://github.com/tesseract-ocr/tesseract)).

Some tools: 
- Text-based only:
    - [camelot](https://camelot-py.readthedocs.io/en/master/)
    - [tabula-py](https://github.com/chezou/tabula-py)
    - [pdfplumber](https://github.com/jsvine/pdfplumber/discussions/908)

- Supports scanned tables (images/pixels):
    - [pymupdf](https://medium.com/@pymupdf/yes-pymupdf-can-be-used-to-extract-tables-from-scanned-images-731c7557b59e ): uses tesseract. Support both text-based and scans. Read their [doc](https://pymupdf.readthedocs.io/en/latest/recipes-text.html#how-to-extract-table-content-from-documents) and blogs: [here](https://medium.com/@pymupdfhttps://pymupdf.readthedocs.io/en/latest/recipes-text.html#how-to-extract-table-content-from-documents/solving-common-issues-with-table-detection-and-extraction-4df5de2b8d88), and [here](https://medium.com/@pymupdf/table-recognition-and-extraction-with-pymupdf-54e54b40b760). 

    - https://github.com/nlmatics/llmsherpa: gives the option to either go OCR or rule-based (faster). Support both text-based and scans. Supports many formats: DOCX, PPTX, HTML, TXT, XML 

>It's reasonable to assume that most of the time, the table will be in text-based format, given that someone created it with MS Excel/Word in the first place.

## Level 2: Context of the table

Getting the table is not enough: Similarity search engines dont' understand numbers unless you tell them what they mean. So, **context** is needed.

To fetch the context, you can look around in the document:
- where the table name was mentioned
- texts surrounding the table (before and after)

## Level 3: LLM to generate the context

In a tutorial [LlamaIndex notebook](https://docs.llamaindex.ai/en/stable/examples/query_engine/sec_tables/tesla_10q_table/), [`unstructured`](https://github.com/Unstructured-IO/unstructured) was shown using LLM as backend to generate table context, although what's going in to generate that context - I'm still looking

![tesla-10k-report-2021-consolidated-statements-of-operations.png](/home/tung/websites/my_note/content/attachments/tesla-10k-report-2021-consolidated-statements-of-operations.png)
To be specific: 
- `unstructured` can tell table from non-table elements, and will handle each element type accordingly.
- it creates nodes to represent information chunks. A table's node is created by indexing summarization of its content.

In other words, the table is approximately represented by it's summarization. The summarization includes: column name, column data type, column's meaning, and a general description for the whole table. For instance, this table (page 50th, [tesla_2021_10k.htm](https://www.dropbox.com/scl/fi/mlaymdy1ni1ovyeykhhuk/tesla_2021_10k.htm?rlkey=qf9k4zn0ejrbm716j0gg7r802&dl=1)):

<p align="center">
  <img src="attachments/tesla-10k-report-2021-consolidated-statements-of-operations.png" alt="tesla-10k-report"/>
</p>

will be assigned an id (`Index ID: id_617_table`), which shows that the table is detected. The table is summarized like so (generated by a LLM):

```
--------
col_schema: Column: Type
Type: string
Summary: Type of net income (loss) per share calculation (basic or diluted)

Column: Amount
Type: string
Summary: Net income (loss) per share amount

Column: Weighted Average Shares
Type: string
Summary: Number of shares used in calculating net income (loss) per share

Summary of net income (loss) per share of common stock attributable to common stockholders
--------
```

The column summary is not quite technically correct (e.g., Weighted Average Shares is not a column) but the table context is there, sort of.

> The concept of retrieving the relevant information chunk, then the table containing that info, is termed by LlamaIndex [*Recursive Retrieving*](https://docs.llamaindex.ai/en/stable/examples/query_engine/pdf_tables/recursive_retriever/)

## Conclusion

- Tables are tricky. Tables usually show up in html or pdf files. Tools are created around these formats
- Recent solution to indexing tables involve indexing the table's context-extractive or generated.
- New solutions keep comning out: `llmsherpa` was developed with RAG in mind, worth looking into. Langchain covered llmsherpa [here](https://python.langchain.com/docs/integrations/document_loaders/llmsherpa/)

---
Resources:

I've been studying Kien's extensive, brilliant notes at [howaibuildthis.substack.com](howaibuildthis.substack.com). I hope Kien keeps on writing stuff (it's been a long while since his last blog).

- https://howaibuildthis.substack.com/p/rag-pipeline-pitfalls-the-untold
- https://howaibuildthis.substack.com/p/llamaindex-how-to-use-index-correctly
- https://howaibuildthis.substack.com/p/a-guide-to-processing-tables-in-rag
